var ticketNames,ticketPoints,inProgress=!1,size=60;function map(a,f){for(var i=0;i<a.length;i++)f(a[i],i)}function getNames(){return $(".name-text-field").val().split("\n").filter(function(name){return name.trim()})}function process(){$(".name-text-field").val().split("\n");imported=[],map(getNames(),function(name){imported.push({name:name})}),$(".enter-names").hide(500,function(){makeTicketsWithPoints()})}function elementInViewport(el){for(var top=el.offsetTop,left=el.offsetLeft,width=el.offsetWidth,height=el.offsetHeight;el.offsetParent;)top+=(el=el.offsetParent).offsetTop,left+=el.offsetLeft;return top>=window.pageYOffset&&left>=window.pageXOffset&&top+height<=window.pageYOffset+window.innerHeight&&left+width<=window.pageXOffset+window.innerWidth}function Ticket(name,points){this.name=name,this.points="number"==typeof points?points:1,this.dom=$("<div class='ticket'>").text(name),this.fixPosition=function(){this.dom.css({background:colors.length>this.points?colors[this.points]:"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+")"})},this.decrement=function(length,callback){if(this.points--,0==this.points){var directions=["up","down","left","right"];this.dom.css({"background-color":colors[0]}).hide("drop",{direction:directions[length%directions.length]},length<=3?750:3e3/length,function(){callback()}),$("#participant-number").text(length-1+"/"+tickets.length)}else this.dom.css({"background-color":colors.length>this.points?colors[this.points]:"rgb("+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+","+Math.floor(256*Math.random())+")"}),setTimeout(function(){callback()},2==length?1e3:3e3/length)}}$(document).ready(function(){imported&&0<imported.length&&($(".enter-names").hide(),makeTicketsWithPoints()),$(".name-text-field").on("input",function(){$("#participant-number").text(getNames().length||"")})});var tickets=[],removeDuplicateNames=function(data){var seen={};return data.filter(function(d){return!seen[d.name.toLowerCase()]&&(seen[d.name.toLowerCase()]=!0)})},makeTicketsWithPoints=function(){for(tickets=[],$(".ticket").remove(),map(removeDuplicateNames(imported),function(tdata){var t=new Ticket(tdata.name,tdata.points);0<t.points&&t.dom.appendTo($("#ticket-block-wrapper")),tickets.push(t)}),tickets.reverse(),size=200,$(".ticket").css("font-size",size+"%");!elementInViewport(tickets[0].dom.get(0))&&10<size;)size--,$(".ticket").css("font-size",size+"%");$("#participant-number").css("width","").text(tickets.length),setTimeout(function(){map(tickets,function(ticket){ticket.fixPosition()}),$("body").unbind("click").click(function(){var width=$("#participant-number").text(tickets.length+"/"+tickets.length).width();$("#participant-number").css("width",width+"px"),pickName()})},500)},getChoices=function(){var result=[];return map(tickets,function(ticket){0<ticket.points&&result.push(ticket)}),result};$(window).resize(function(){inProgress||makeTicketsWithPoints(tickets)});var pickName=function(){inProgress=!0,$(".ticket").unbind("click"),$("body").unbind("click");var choices=getChoices();if(1<choices.length){var remove=Math.floor(Math.random()*choices.length);choices[remove].decrement(choices.length,function(){pickName()})}else{var top=(choices=$(choices[0].dom)).css("top"),left=choices.css("left"),fontsize=choices.css("font-size"),width=choices.width();choices.click(function(){inProgress=!1,choices.animate({"font-size":fontsize,top:top,left:left},"slow"),$(".ticket").show(500).unbind("click"),setTimeout(function(){makeTicketsWithPoints(ticketNames,ticketPoints)},700)}),choices.animate({"font-size":3*size+"%",top:window.innerHeight/5+"px",left:window.innerWidth/2-width+"px"},1500,function(){choices.animate({left:window.innerWidth/2-choices.width()/2+"px"},"slow")})}};